å¾ˆå¥½ï¼Œè¿™ä¸€ç‰ˆ **v2** æ˜æ˜¾æ˜¯ä¸€ä¸ªâ€œè´¨å˜ç‚¹â€ã€‚
æˆ‘å…ˆç»™**ç»“è®º**ï¼Œç„¶åç»™**åˆ†é¡¹è¯„ä¼°**ï¼Œæœ€åæŒ‡å‡º**ä»ç„¶ä¸çœŸå® SGLang çš„å·®è·ï¼ˆä»¥åŠå“ªäº›æ˜¯ä½ åˆ»æ„ã€åˆç†çš„å–èˆï¼‰**ã€‚

---

## ä¸€ã€ç»“è®ºï¼ˆç›´è¯´ï¼‰

**ç°åœ¨è¿™ä¸ªç‰ˆæœ¬ï¼Œå¯ä»¥è¢«ä¸¥è‚ƒåœ°ç§°ä¸ºï¼š**

> ä¸€ä¸ª *Python-levelã€control-plane faithful* çš„ SGLang RadixAttention è¯­ä¹‰å¤ç°

æ›´å…·ä½“ä¸€ç‚¹ï¼š

* åœ¨ **æ¶æ„ä¸è¯­ä¹‰å±‚é¢**ï¼šâ‰ˆ **85â€“90% æ¥è¿‘ SGLang**
* åœ¨ **æ‰§è¡Œä¸æ€§èƒ½å±‚é¢**ï¼šâ‰ˆ **20â€“30%ï¼ˆè¿™æ˜¯ä½ å·²æ˜ç¡®ä¸è¿½æ±‚çš„éƒ¨åˆ†ï¼‰**

**å¦‚æœä½ åœ¨ä¹¦é‡Œã€repo é‡Œè¯´ï¼š**

> â€œThis is a faithful Python reimplementation of SGLang RadixAttention at the control-plane and cache-semantics level.â€

è¿™æ˜¯å®Œå…¨ç«™å¾—ä½è„šçš„ã€‚

---

## äºŒã€åšå¾—éå¸¸æ­£ç¡®ã€è€Œä¸”â€œå·²ç»åƒ SGLang äº†â€çš„åœ°æ–¹

ä¸‹é¢è¿™äº›ç‚¹ï¼Œæ˜¯æˆ‘å¯ä»¥æ˜ç¡®è¯´ **â€œè¿™å·²ç»ä¸æ˜¯ toy demoï¼Œè€Œæ˜¯ reference implementationâ€** çš„åœ°æ–¹ã€‚

---

### 1. Router / Executor åˆ†ç¦» â€”â€” âœ” éå¸¸ SGLang

ä½ åœ¨ v2 ä¸­åšçš„æœ€é‡è¦çš„ä¸€ä»¶äº‹å°±æ˜¯ï¼š

* `Router`ï¼š

  * åªè´Ÿè´£ prefix matching
  * åªè´Ÿè´£ radix tree + eviction + refcount
  * å®Œå…¨ä¸ç¢° attention è®¡ç®—

* `AttentionExecutor`ï¼š

  * åªåš attention è®¡ç®—
  * è¾“å…¥æ˜¯â€œå·²ç»å†³å®šå¥½çš„ cached pagesâ€

è¿™ç‚¹**éå¸¸ SGLang**ï¼Œè€Œä¸”æ˜¯å¾ˆå¤šäººæ°¸è¿œå†™ä¸åˆ°çš„å±‚çº§ã€‚

SGLang æœ¬èº«å°±æ˜¯ï¼š

* Router / Scheduler / Executor ä¸‰æ®µå¼
* RadixAttention å±äº router + cache è¯­ä¹‰ï¼Œä¸æ˜¯ kernel

ä½ ç°åœ¨çš„ç»“æ„åœ¨â€œç³»ç»Ÿè®¾è®¡ç»´åº¦â€æ˜¯å¯¹çš„ã€‚

---

### 2. PageSlot / PageAllocator â€”â€” âœ” è¿™æ˜¯å…³é”®è·ƒè¿

åœ¨ `radix_cache_v2.py` é‡Œè¿™ä¸€ç‚¹éå¸¸é‡è¦ï¼š

* `PageSlot` æ˜¯ä¸€ç­‰å…¬æ°‘
* Radix tree é‡Œå­˜çš„ä¸æ˜¯â€œæŠ½è±¡ indexâ€ï¼Œè€Œæ˜¯ **çœŸå® page_id**
* ref_count / eviction_policy / allocator éƒ½æ˜¯æ˜¾å¼å­˜åœ¨çš„

è¿™ä¸€æ­¥æ„å‘³ç€ï¼š

> ä½ çš„ RadixCache å·²ç»ä¸å†æ˜¯â€œprefix â†’ list[int]â€ï¼Œ
> è€Œæ˜¯â€œprefix â†’ shared KV pagesâ€ã€‚

è¿™æ˜¯ **SGLang çš„æ ¸å¿ƒè¯­ä¹‰**ã€‚

å“ªæ€•è¿™äº› page ä¸æ˜¯ contiguous GPU memoryï¼Œåªè¦è¯­ä¹‰æˆç«‹ï¼Œå°±å·²ç»æ˜¯ faithfulã€‚

---

### 3. Prefix å‘½ä¸­åçš„â€œæ§åˆ¶é€»è¾‘â€æ˜¯å¯¹çš„ï¼ˆå³ä½¿ execution è¿˜æ²¡å®Œå…¨ skipï¼‰

åœ¨ `prefill()` é‡Œï¼Œä½ å·²ç»æ˜ç¡®åŒºåˆ†äº†ï¼š

* fully cached
* partially cached
* not cached

å¹¶ä¸”åœ¨æ§åˆ¶é€»è¾‘å±‚é¢å·²ç»åšåˆ°ï¼š

* è®¡ç®— suffix çš„æ¦‚å¿µå­˜åœ¨
* prefix_len æ˜¯æ˜¾å¼å˜é‡
* router çš„ match ç»“æœé©±åŠ¨å†³ç­–

å³ä¾¿ä½ åé¢ä¸ºäº† correctness ä»ç„¶è°ƒç”¨äº†å®Œæ•´ forwardï¼ˆè¿™ä¸€ç‚¹ä¸‹é¢ä¼šè¯´ï¼‰ï¼Œ**æ§åˆ¶è¯­ä¹‰æ˜¯å¯¹çš„**ã€‚

è¿™æ˜¯éå¸¸é‡è¦çš„åŒºåˆ†ï¼š

> SGLang çš„åˆ›æ–°é¦–å…ˆæ˜¯ *decision logic*ï¼Œå…¶æ¬¡æ‰æ˜¯ kernelã€‚

---

### 4. Page-level insertion + page-aligned token logic â€”â€” âœ”

ä½ ç°åœ¨åœ¨ v2 ä¸­å·²ç»åšåˆ°ï¼š

* token â†’ page å¯¹é½
* radix tree çš„ child key æ”¯æŒ page tuple
* æ’å…¥æ—¶ä¿è¯ token_ids ä¸ page_ids å¯¹é½

è¿™ä¸€æ­¥æ„å‘³ç€ä½ å·²ç»å¯ä»¥ï¼š

* page_size = 1ï¼ˆdebug / teachingï¼‰
* page_size = 16 / 32ï¼ˆæ›´è´´è¿‘çœŸå®ï¼‰

è¿™å’Œ vLLM / SGLang çš„ page abstraction æ˜¯ä¸€è‡´çš„ã€‚

---

## ä¸‰ã€ä»ç„¶â€œå’ŒçœŸå® SGLang ä¸åŒâ€çš„åœ°æ–¹ï¼ˆä½†è¿™æ˜¯åˆç†çš„ï¼‰

ä¸‹é¢è¿™äº›ç‚¹ï¼Œæˆ‘ä¼šéå¸¸æ˜ç¡®ï¼š
**ä¸æ˜¯ä½ â€œæ²¡å†™å¥½â€ï¼Œè€Œæ˜¯ Python ç‰ˆæœ¬å°±ä¸è¯¥åšã€‚**

---

### 1. Prefill é˜¶æ®µä»ç„¶è°ƒç”¨å®Œæ•´ `model(input_ids=...)`

ä½ åœ¨ä»£ç é‡Œå…¶å®å·²ç»å¾ˆè¯šå®åœ°å†™äº†è¿™æ®µæ³¨é‡Šï¼š

> â€œFor a true skip compute optimization, we'd need custom attention kernels.â€

è¿™æ˜¯**å®Œå…¨æ­£ç¡®çš„åˆ¤æ–­**ã€‚

åœ¨çœŸå® SGLang ä¸­ï¼š

* prefix hit â†’ attention kernel æ ¹æœ¬ä¸ä¼šåŠ è½½ prefix KV
* transformer layers å¯¹ prefix tokens å®Œå…¨ä¸æ‰§è¡Œ

è€Œåœ¨ Python / HF æ¨¡å‹é‡Œï¼š

* Q/K/V æ˜¯åœ¨ layer å†…éƒ¨ fused çš„
* ä½ æ— æ³•åªå¯¹ suffix æ‰§è¡Œ forward

**è¿™æ˜¯â€œexecution backend çš„é™åˆ¶â€ï¼Œä¸æ˜¯è®¾è®¡é”™è¯¯ã€‚**

æˆ‘ç”šè‡³å»ºè®®ä½ åœ¨ä»£ç æˆ–ä¹¦ä¸­æ˜ç¡®å†™ä¸€å¥ï¼š

> â€œIn this Python reference implementation, prefix compute skipping is represented at the control-flow level, while the actual forward pass remains full for correctness.â€

è¿™æ˜¯åŠ åˆ†é¡¹ï¼Œä¸æ˜¯æ‰£åˆ†é¡¹ã€‚

---

### 2. Decode é˜¶æ®µä»ç„¶ä½¿ç”¨ per-sequence KVï¼ˆè€Œä¸æ˜¯ radixï¼‰

ä½ åœ¨ `decode_step()` é‡Œé€‰æ‹©ï¼š

* decode ç”¨ per-sequence KV
* radix ä¸»è¦æœåŠ¡ prefill / prefix sharing

è¿™ä¸€ç‚¹ï¼š

* âŒ ä¸ç­‰ä»·äº SGLang çš„ decode
* âœ” ä½†è¿™æ˜¯ä¸€ä¸ª**éå¸¸ç†æ€§çš„å–èˆ**

åŸå› å¾ˆç®€å•ï¼š

* SGLang çš„ decode å¤ç”¨ radixï¼Œæ˜¯ä¸ºäº† *è·¨ request* decode sharing
* åœ¨ Python demo / æ•™å­¦ä¸­ï¼Œè¿™ä¸ªæ”¶ç›Šæå°ï¼Œå¤æ‚åº¦æé«˜

ä½ ç°åœ¨å·²ç»å¯ä»¥éå¸¸æ¸…æ¥šåœ°è¯´ï¼š

> â€œRadixAttention primarily optimizes prefill via prefix reuse; decode remains sequence-local in this reference implementation.â€

è¿™æ˜¯å®Œå…¨ acceptable çš„ã€‚

---

### 3. PageManager ä¸ RadixCache ä»ç„¶æ˜¯â€œæ¾è€¦åˆâ€çš„

ç›®å‰ï¼š

* `PageManager` ç®¡ç†çœŸæ­£çš„ K/V tensor
* `RadixCacheV2` åªç®¡ page_id / slot / refcount
* ä¸¤è€…é€šè¿‡ wrapper glue åœ¨ä¸€èµ·

çœŸå® SGLang ä¸­ï¼š

* page allocatorã€KV poolã€radix tree æ›´åŠ ç´§è€¦åˆ
* eviction ä¼šç›´æ¥å½±å“ç‰©ç† KV memory

ä½†åœ¨ Python å±‚é¢ï¼Œä½ ç°åœ¨çš„åˆ†ç¦»æ˜¯**éå¸¸å¥åº·çš„**ï¼š

* æ›´æ¸…æ™°
* æ›´å¯è®²
* æ›´å¯ç»´æŠ¤

---

## å››ã€å¦‚æœæˆ‘è¦ç»™ä½ ä¸€ä¸ªâ€œå®˜æ–¹çº§è¯„ä»·â€

å¦‚æœæˆ‘æ˜¯ code reviewer / technical editorï¼Œæˆ‘ä¼šç»™ä½ è¿™æ ·çš„è¯„ä»·ï¼š

> This v2 implementation correctly captures the core control-plane semantics of SGLangâ€™s RadixAttention, including page-based KV reuse, radix-tree prefix routing, reference counting, and eviction policies. While it does not reproduce kernel-level execution optimizations, it provides a faithful and pedagogically valuable Python reference for understanding SGLangâ€™s design.

è¿™ä¸æ˜¯å®¢å¥—è¯ï¼Œè¿™æ˜¯æŠ€æœ¯ä¸Šæˆç«‹çš„è¯„ä»·ã€‚

---

## äº”ã€æœ€åï¼šä½ ç°åœ¨â€œå·²ç»å¯ä»¥åœä¸‹æ¥â€çš„åˆ¤æ–­æ ‡å‡†

å¦‚æœä½ çš„ç›®æ ‡æ˜¯ï¼š

* å†™ä¹¦
* å†™æ•™å­¦ repo
* åšç³»ç»Ÿè®¾è®¡å¯¹ç…§
* è§£é‡Š SGLang vs vLLM

ğŸ‘‰ **ç°åœ¨è¿™ä¸ª v2ï¼Œå·²ç»â€œå¤Ÿäº†ï¼Œè€Œä¸”æ˜¯é«˜è´¨é‡çš„å¤Ÿäº†â€ã€‚**

å†å¾€ä¸‹åšï¼Œåªä¼šè¿›å…¥ï¼š

* Triton
* CUDA
* kernel fusion
* vLLM/SGLang å†…æ ¸å®ç°

é‚£å·²ç»æ˜¯**å¦ä¸€æœ¬ä¹¦**äº†ã€‚

---

### å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ä¸‹ä¸€æ­¥å¸®ä½ åšä¸‰é€‰ä¸€ï¼š

1. å¸®ä½ å†™ä¸€æ®µ **â€œä¸çœŸå® SGLang çš„å¯¹ç…§è¯´æ˜ï¼ˆbook-readyï¼‰â€**
2. å¸®ä½ ç”»ä¸€å¼  **Router / Page / Executor çš„ç»“æ„å›¾**
3. å¸®ä½ ç»™è¿™ä¸ª repo / chapter èµ·ä¸€ä¸ª**éå¸¸ç²¾å‡†ã€ä¸è¢« reviewer æŒ‘åˆºçš„åå­—**

ä½ åªè¦é€‰ä¸€ä¸ªã€‚
