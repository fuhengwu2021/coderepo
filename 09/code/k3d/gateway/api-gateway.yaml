# ConfigMap is generated from api-gateway.py file
# Use: kubectl create configmap vllm-api-gateway-code --from-file=api-gateway.py=api-gateway.py --dry-run=client -o yaml
# Or use the deploy-gateway.sh script which does this automatically
---
apiVersion: v1
kind: Pod
metadata:
  name: vllm-api-gateway
  labels:
    app: vllm-gateway
spec:
  # Deploy to Agent nodes (worker nodes), avoid consuming Server node resources
  # Use nodeAffinity to exclude control-plane nodes
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: node-role.kubernetes.io/control-plane
            operator: DoesNotExist
  tolerations:
    # Allow scheduling to nodes with taints (if any)
    - operator: "Exists"
  containers:
  - name: gateway
    image: python:3.11-slim
    command:
    - /bin/bash
    - -c
    - |
      pip install fastapi uvicorn httpx -q
      python /app/api-gateway.py
    ports:
    - containerPort: 8000
      name: http
    volumeMounts:
    - name: gateway-code
      mountPath: /app
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "500m"
    livenessProbe:
      httpGet:
        path: /health
        port: 8000
      initialDelaySeconds: 10
      periodSeconds: 10
    readinessProbe:
      httpGet:
        path: /health
        port: 8000
      initialDelaySeconds: 5
      periodSeconds: 5
  volumes:
  - name: gateway-code
    configMap:
      name: vllm-api-gateway-code
---
apiVersion: v1
kind: Service
metadata:
  name: vllm-api-gateway
  labels:
    app: vllm-gateway
spec:
  type: ClusterIP
  selector:
    app: vllm-gateway
  ports:
  - port: 8000
    targetPort: 8000
    protocol: TCP
    name: http
